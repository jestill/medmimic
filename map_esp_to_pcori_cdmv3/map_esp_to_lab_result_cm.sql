
-- Create the lab results query
CREATE TABLE PCORI_CDMV3.LAB_RESULT_CM (
  LAB_RESULT_CM_ID    VARCHAR(50),
  PATID               VARCHAR(50),   /* mrn */
  ENCOUNTERID         VARCHAR(50),
  LAB_NAME            VARCHAR(10),
  SPECIMEN_SOURCE     VARCHAR(10),
  LAB_LOINC           VARCHAR(10),
  PRIORITY            VARCHAR(2),
  RESULT_LOC          VARCHAR(2),
  LAB_PX              VARCHAR(11),   /* */
  LAB_PX_TYPE         CHAR(2),       /* CPT?  */
  LAB_ORDER_DATE      DATE,          /* date */
  SPECIMEN_DATE       DATE,          /* collection_date */
  SPECIMEN_TIME       CHAR(5),       /* NULL */
  RESULT_DATE         DATE,          /* result_date */
  RESULT_TIME         CHAR(5),       /* NULL */
  RESULT_QUAL         VARCHAR(12),   /* Qualitative result */
  RESULT_NUM          FLOAT,         /* Quantitative result */
  RESULT_MODIFIER     CHAR(2),       /* NULL */
  RESULT_UNIT         VARCHAR(11),   /* From RAW_UNIT */
  NORM_RANGE_LOW      VARCHAR(10),   /* ref_low_string */
  NORM_MODIFIER_LOW   CHAR(2),       /* NULL */
  NORM_RANGE_HIGH     VARCHAR(10),   /* ref_high_string */
  NORM_MODIFIER_HIGH  CHAR(2),       /* NULL */
  ABN_IND             CHAR(2),       /* abnormal_flag */
  RAW_LAB_NAME        VARCHAR(250),   /* native_name */
  RAW_LAB_CODE        VARCHAR(250),   /* native_code */
  RAW_PANEL           VARCHAR(250),
  RAW_RESULT          VARCHAR(250),   /*   */
  RAW_UNIT            VARCHAR(250),   /* REF_UNIT   */
  RAW_ORDER_DEPT      VARCHAR(250),
  RAW_FACILITY_CODE   VARCHAR(250)
)


-- Insert data from ESP simulation
INSERT INTO PCORI_CDMV3.LAB_RESULT_CM (
  LAB_RESULT_CM_ID,
  PATID,
  LAB_ORDER_DATE,
  SPECIMEN_DATE,
  RESULT_DATE,
  RESULT_NUM,
  NORM_RANGE_LOW,
  NORM_RANGE_HIGH,
  ABN_IND,
  RAW_LAB_CODE,
  RAW_LAB_NAME,
  RAW_RESULT,
  RAW_UNIT
)
SELECT
  CAST ((md5(random()::text || clock_timestamp()::text)::uuid) AS VARCHAR),
  MRN               AS PATID,
  DATE              AS LAB_ORDER_DATE,
  COLLECTION_DATE   AS SPECIMEN_DATE,
  RESULT_DATE       AS RESULT_DATE,
  RESULT_FLOAT      AS RESULT_NUM,
  REF_LOW_STRING    AS NORM_RANGE_LOW,
  REF_HIGH_STRING   AS NORM_RANGE_HIGH,
  ABNORMAL_FLAG     AS ABN_IND,
  NATIVE_CODE       AS RAW_LAB_CODE,
  NATIVE_NAME       AS RAW_LAB_NAME,
  RESULT_STRING     AS RAW_RESULT,
  REF_UNIT          AS RAW_UNIT
FROM PUBLIC.EMR_LABRESULT;


-- Drop bad simulated data
-- Drop wehre specimens were collected after
-- the result was reported
DELETE
FROM PCORI_CDMV3.LAB_RESULT_CM
WHERE SPECIMEN_DATE > RESULT_DATE;


-- Set type to CPT-4
UPDATE PCORI_CDMV3.LAB_RESULT_CM
SET LAB_PX_TYPE = 'C4';

-- Create a staging table for translating the lab codes
-- in the simulated data to s
-- will pull some of the common ones for Reference Table 1
CREATE TABLE PCORI_CDMV3.LAB_RESULT_STAGING (
  RAW_LAB_CODE      VARCHAR(250),
  RAW_LAB_NAME      VARCHAR(250),
  RAW_UNIT          VARCHAR(250),
  SPECIMEN_SOURCE   VARCHAR(10),  
  LAB_LOINC         VARCHAR(10),
  LAB_PX            VARCHAR(11),   /* */
  LAB_PX_TYPE       CHAR(2),       /* CPT?  */
  LAB_NAME          VARCHAR(10)  
);


INSERT INTO PCORI_CDMV3.LAB_RESULT_STAGING (
  RAW_LAB_CODE,
  RAW_LAB_NAME,
  RAW_UNIT
)
SELECT
DISTINCT
  RAW_LAB_CODE,
  RAW_LAB_NAME,
  RAW_UNIT
FROM PCORI_CDMV3.LAB_RESULT_CM;



-- Add some values to the staging table
UPDATE PCORI_CDMV3.LAB_RESULT_STAGING
SET
  SPECIMEN_SOURCE = 'BLOOD',
  LAB_PX = '85018',
  LAB_LOINC = '718-7',
  LAB_NAME = 'HGB',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '85018%';


-- set the source to unknown
UPDATE PCORI_CDMV3.LAB_RESULT_STAGING
SET
  SPECIMEN_SOURCE = 'UN',
  LAB_PX = '82565',
  LAB_LOINC = '2160-0',
  LAB_NAME = 'CREATININE',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '82565%';


UPDATE PCORI_CDMV3.LAB_RESULT_STAGING
SET
  SPECIMEN_SOURCE = 'BLOOD',
  LAB_PX = '85610',
  LAB_LOINC = '34714-6',
  LAB_NAME = 'INR',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '85610%';


UPDATE PCORI_CDMV3.LAB_RESULT_STAGING
SET
  SPECIMEN_SOURCE = 'BLOOD',
  LAB_PX = '85014',
  LAB_LOINC = '4548-4',
  LAB_NAME = 'A1C',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '85014%';



UPDATE PCORI_CDMV3.LAB_RESULT_STAGING
SET
  SPECIMEN_SOURCE = 'BLOOD',
  LAB_PX = '82948',
  LAB_LOINC = '2345-7',
  LAB_NAME = 'FBS',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '82948%';


UPDATE PCORI_CDMV3.LAB_RESULT_STAGING
SET
  SPECIMEN_SOURCE = 'SERUM',
  LAB_PX = '80076',
  LAB_LOINC = '1971-1',
  LAB_NAME = 'BILI_IND',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '80076%';


UPDATE PCORI_CDMV3.LAB_RESULT_STAGING
SET
  SPECIMEN_SOURCE = 'SERUM',
  LAB_PX = '84075',
  LAB_LOINC = '6768-6',
  LAB_NAME = 'ALK PHOS',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '84075%';
















-- Trying to use the staging table did not work ...
-- so just directly modifying the table



UPDATE PCORI_CDMV3.LAB_RESULT_CM
SET
  SPECIMEN_SOURCE = 'BLOOD',
  LAB_PX = '85018',
  LAB_LOINC = '718-7',
  LAB_NAME = 'HGB',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '85018%';


-- set the source to unknown
UPDATE PCORI_CDMV3.LAB_RESULT_CM
SET
  SPECIMEN_SOURCE = 'UN',
  LAB_PX = '82565',
  LAB_LOINC = '2160-0',
  LAB_NAME = 'CREATININE',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '82565%';


UPDATE PCORI_CDMV3.LAB_RESULT_CM
SET
  SPECIMEN_SOURCE = 'BLOOD',
  LAB_PX = '85610',
  LAB_LOINC = '34714-6',
  LAB_NAME = 'INR',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '85610%';


UPDATE PCORI_CDMV3.LAB_RESULT_CM
SET
  SPECIMEN_SOURCE = 'BLOOD',
  LAB_PX = '85014',
  LAB_LOINC = '4548-4',
  LAB_NAME = 'A1C',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '85014%';



UPDATE PCORI_CDMV3.LAB_RESULT_CM
SET
  SPECIMEN_SOURCE = 'BLOOD',
  LAB_PX = '82948',
  LAB_LOINC = '2345-7',
  LAB_NAME = 'FBS',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '82948%';


UPDATE PCORI_CDMV3.LAB_RESULT_CM
SET
  SPECIMEN_SOURCE = 'SERUM',
  LAB_PX = '80076',
  LAB_LOINC = '1971-1',
  LAB_NAME = 'BILI_IND',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '80076%';


UPDATE PCORI_CDMV3.LAB_RESULT_CM
SET
  SPECIMEN_SOURCE = 'SERUM',
  LAB_PX = '84075',
  LAB_LOINC = '6768-6',
  LAB_NAME = 'ALK PHOS',
  LAB_PX_TYPE = 'C4'
WHERE RAW_LAB_CODE LIKE '84075%';



























-- Then Update from staging to the result table

UPDATE PCORI_CDMV3.LAB_RESULT_CM
LEFT JOIN
  LAB_RESULT_STAGING
ON
  LAB_RESULT_CM.RAW_LAB_CODE = LAB_RESULT_STAGING.RAW_LAB_CODE
SET 
  LAB_RESULT_CM.SPECIMEN_SOURCE = LAB_RESULT_STAGING.SPECIMEN_SOURCE,
  LAB_RESULT_CM.LAB_PX = LAB_RESULT_STAGING.LAB_PX,
  LAB_RESULT_CM.LAB_LOINC =  LAB_RESULT_STAGING.LAB_LOINC,
  LAB_RESULT_CM.LAB_NAME = LAB_RESULT_STAGING.LAB_NAME,
  LAB_RESULT_CM.LAB_PX_TYPE = LAB_RESULT_STAGING.LAB_PX_TYPE
WHERE LAB_RESULT_STAGING.LAB_LOINC IS NOT NULL;




UPDATE PCORI_CDMV3.LAB_RESULT_CM
LEFT JOIN
  LAB_RESULT_STAGING
ON
  LAB_RESULT_CM.RAW_LAB_CODE = LAB_RESULT_STAGING.RAW_LAB_CODE
SET 
  LAB_RESULT_CM.SPECIMEN_SOURCE = LAB_RESULT_STAGING.SPECIMEN_SOURCE;






-- Can check how many have usable data with
-- see how many have some usable data
SELECT COUNT(*) 
FROM PCORI_CDMV3.LAB_RESULT_CM
LEFT JOIN 
PCORI_CDMV3.LAB_RESULT_STAGING
ON
PCORI_CDMV3.LAB_RESULT_CM.RAW_LAB_CODE = LAB_RESULT_STAGING.RAW_LAB_CODE
WHERE LAB_RESULT_STAGING.LAB_LOINC IS NULL;

-- Find some of the high-occurrence ones
SELECT LAB_RESULT_CM.RAW_LAB_CODE, COUNT(*) 
FROM PCORI_CDMV3.LAB_RESULT_CM
LEFT JOIN 
PCORI_CDMV3.LAB_RESULT_STAGING
ON
PCORI_CDMV3.LAB_RESULT_CM.RAW_LAB_CODE = LAB_RESULT_STAGING.RAW_LAB_CODE
WHERE LAB_RESULT_STAGING.LAB_LOINC IS NULL
GROUP BY LAB_RESULT_CM.RAW_LAB_CODE
ORDER BY RAW_LAB_CODE;
